<?php
/**
 * –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ —Å Kinescope
 * –°–∫–∞—á–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∞—É–¥–∏–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∏ —Å–æ–∑–¥–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è
 */

error_reporting(E_ALL);
ini_set('display_errors', 1);
set_time_limit(0);

require_once __DIR__ . '/utils.php';
require_once __DIR__ . '/kinescope_api.php';
require_once __DIR__ . '/whisper_api.php';
require_once __DIR__ . '/queue_system.php';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
function sanitizeFilename($filename) {
    return preg_replace('/[^a-zA-Z0-9_\-\.]/', '_', $filename);
}

echo "=== –û–ë–†–ê–ë–û–¢–ö–ê –í–ò–î–ï–û –° KINESCOPE ===\n\n";

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
$options = getopt('', ['url:', 'lesson:', 'course:', 'quality:', 'help']);

if (isset($options['help']) || !isset($options['url'])) {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n";
    echo "php process_video.php --url=https://kinescope.io/VIDEO_ID --lesson=1 --course='–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞' [--quality=360p]\n\n";
    echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n";
    echo "  --url=URL        –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ Kinescope\n";
    echo "  --lesson=N       –ù–æ–º–µ—Ä —É—Ä–æ–∫–∞\n";
    echo "  --course=NAME    –ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞\n";
    echo "  --quality=QUAL   –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ (360p, 720p, 1080p) - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 360p\n";
    echo "  --help           –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n";
    echo "–ü—Ä–∏–º–µ—Ä—ã:\n";
    echo "php process_video.php --url=https://kinescope.io/202339654 --lesson=1 --course='–ú–∞—Å—Å–∞–∂ –®–í–ó'\n";
    echo "php process_video.php --url=https://kinescope.io/5NRs6UHWgMX9RtHqxNGy8j --lesson=2 --course='–ú–∞—Å—Å–∞–∂ –®–í–ó' --quality=720p\n";
    exit(0);
}

$videoUrl = $options['url'];
$lessonNumber = $options['lesson'];
$courseName = $options['course'];
$quality = $options['quality'] ?? '360p';

echo "üìπ URL –≤–∏–¥–µ–æ: $videoUrl\n";
echo "üìö –ù–æ–º–µ—Ä —É—Ä–æ–∫–∞: $lessonNumber\n";
echo "üéì –ö—É—Ä—Å: $courseName\n";
echo "üì∫ –ö–∞—á–µ—Å—Ç–≤–æ: $quality\n\n";

try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API
    $config = cfg();
    $kinescope = new KinescopeAPI($config['apis']['kinescope']['api_key']);
    $whisper = new WhisperAPI($config['apis']['whisper']['api_key']);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∏–¥–µ–æ –∏–∑ URL
    $videoId = $kinescope->extractVideoId($videoUrl);
    if (!$videoId) {
        throw new Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å ID –≤–∏–¥–µ–æ –∏–∑ URL: $videoUrl");
    }
    
    echo "üÜî ID –≤–∏–¥–µ–æ: $videoId\n";
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
    echo "üìä –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ...\n";
    $videoInfo = $kinescope->getVideoInfo($videoId);
    echo "üìù –ù–∞–∑–≤–∞–Ω–∏–µ: " . $videoInfo['title'] . "\n";
    echo "‚è±Ô∏è  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: " . round($videoInfo['duration'] / 60, 2) . " –º–∏–Ω\n";
    
    // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∫—É—Ä—Å–∞
    $courseDir = __DIR__ . '/store/' . sanitizeFilename($courseName);
    if (!is_dir($courseDir)) {
        mkdir($courseDir, 0755, true);
        echo "üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ –∫—É—Ä—Å–∞: $courseDir\n";
    }
    
    // –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
    echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ $quality...\n";
    $videoFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '.mp4';
    
    $downloadInfo = $kinescope->getVideoDownloadUrl($videoId, $quality);
    $downloadedSize = $kinescope->downloadVideoWithRetry($downloadInfo['url'], $videoFile);
    
    if (!$downloadedSize || $downloadedSize < 1024) {
        throw new Exception("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ");
    }
    
    echo "‚úÖ –í–∏–¥–µ–æ —Å–∫–∞—á–∞–Ω–æ: " . round($downloadedSize / 1024 / 1024, 2) . " MB\n";
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—É–¥–∏–æ
    echo "üéµ –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—É–¥–∏–æ...\n";
    $audioFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '.wav';
    
    $audioExtracted = $whisper->extractAudio($videoFile, $audioFile);
    if (!$audioExtracted) {
        throw new Exception("–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—É–¥–∏–æ");
    }
    
    echo "‚úÖ –ê—É–¥–∏–æ –∏–∑–≤–ª–µ—á–µ–Ω–æ: " . round(filesize($audioFile) / 1024 / 1024, 2) . " MB\n";
    
    // –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ
    echo "üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ...\n";
    $transcript = $whisper->transcribe($audioFile);
    
    if (!$transcript) {
        throw new Exception("–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏");
    }
    
    echo "‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: " . strlen($transcript) . " —Å–∏–º–≤–æ–ª–æ–≤\n";
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
    $transcriptFile = $courseDir . '/' . sprintf('%02d', $lessonNumber) . '-' . $videoId . '.txt';
    file_put_contents($transcriptFile, $transcript);
    echo "üíæ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $transcriptFile\n";
    
    // –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞
    echo "üìù –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞...\n";
    $description = createLessonDescription($transcript, $lessonNumber, $courseName);
    
    if (!$description) {
        throw new Exception("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–∫–∞");
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    $descriptionFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '-final.json';
    file_put_contents($descriptionFile, json_encode($description, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
    echo "‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: $descriptionFile\n";
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    if (file_exists($videoFile)) {
        unlink($videoFile);
        echo "üóëÔ∏è  –í—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ\n";
    }
    
    if (file_exists($audioFile)) {
        unlink($audioFile);
        echo "üóëÔ∏è  –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∞—É–¥–∏–æ —É–¥–∞–ª–µ–Ω–æ\n";
    }
    
    echo "\nüéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!\n";
    echo "üìÑ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: $transcriptFile\n";
    echo "üìã –û–ø–∏—Å–∞–Ω–∏–µ: $descriptionFile\n";
    
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
    exit(1);
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
 */
function createLessonDescription($transcript, $lessonNumber, $courseName) {
    $config = cfg();
    
    $prompt = "–°—Ñ–æ—Ä–º–∏—Ä—É–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é, –∫—Ä–∞—Ç–∫—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (¬´—Ä—ã–±—É¬ª) —É—Ä–æ–∫–∞ –ø–æ –º–∞—Å—Å–∞–∂—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏, —Å–æ–±–ª—é–¥–∞—è —Å–ª–µ–¥—É—é—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç:

- –û—Å–Ω–æ–≤–∞ –æ—Ç–≤–µ—Ç–∞: –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏—Å—Ö–æ–¥–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è, –Ω–∏–∫–∞–∫–∏—Ö –ª–∏—á–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∏–ª–∏ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤.
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –ª–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–ª–∏ —É—á–µ–Ω–∏–∫–∞, –±–µ–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ –∂–∏–∑–Ω–∏, –±–µ–∑ —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ ¬´–Ω–∞ —ç—Ç–æ–º —É—Ä–æ–∫–µ¬ª.
- –í –ø–æ–ª—è—Ö –∏—Å–ø–æ–ª—å–∑—É–π —á—ë—Ç–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É –∏ —Å–æ–±–ª—é–¥–∞–π —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ–±—ä–µ–º.
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ –≤–∏–¥–µ JSON –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∏–∂–µ, –ë–ï–ó HTML, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–¥–∞.

–ü–æ–ª—è –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- \"summary_short\": –û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (12‚Äì18 —Å–ª–æ–≤) –æ —Å—É—Ç–∏ –Ω–∞–≤—ã–∫–∞/–∑–Ω–∞–Ω–∏—è –∏–∑ —ç—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏—è –≤—Ä–æ–¥–µ ¬´–≤ —ç—Ç–æ–º —É—Ä–æ–∫–µ¬ª, —Ç–æ–ª—å–∫–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.
- \"prev_lessons\": –û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º (\"\"), –µ—Å–ª–∏ —É—Ä–æ–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–≤—è–∑–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏.
- \"why_watch\": 400‚Äì600 –∑–Ω–∞–∫–æ–≤ –æ —Å—Ä–æ—á–Ω–æ–π –ø–æ–ª—å–∑–µ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏: –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏, –ø–æ–ª—å–∑—É —Å–µ–π—á–∞—Å –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –Ω–∞ –±—É–¥—É—â–µ–µ.
- \"quick_action\": –û–¥–Ω–∞ –±—ã—Å—Ç—Ä–∞—è —Ç–µ—Ö–Ω–∏–∫–∞/–¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –ø—Ä–∏—ë–º –ø–æ —Ç–µ–º–µ, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞ 1‚Äì2 –º–∏–Ω—É—Ç—ã, —á–µ—Ç–∫–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.
- \"social_share\": –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π, –Ω–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ –ª—ë–≥–∫–∏–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —à—Ç–∞–º–ø–æ–≤ –∏ —Ñ–æ—Ä–º–∞–ª–∏–∑–º–æ–≤), –ø–µ—Ä–µ–¥–∞—é—â–∏–π –∏–Ω—Å–∞–π—Ç/–≥–ª–∞–≤–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–º –∑–∞—Ö–æ—á–µ—Ç—Å—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Instagram/Telegram.
- \"homework_20m\": –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º–æ–µ –∑–∞–¥–∞–Ω–∏–µ, —Ä–∞–∑–±–∏—Ç–æ–µ –Ω–∞ —á–µ—Ç–∫–∏–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–¥–æ 20 –º–∏–Ω—É—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏).

–ü–æ—Ä—è–¥–æ–∫ –∏ –º–µ—Ç–æ–¥:
1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é: –≤—ã–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã, –ø—Ä–∏—ë–º—ã, –≤–∞–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ ¬´–±–æ–ª–∏¬ª –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
2. –ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (—à–∞–≥ –∑–∞ —à–∞–≥–æ–º) –≤—ã—Ä–∞–±–æ—Ç–∞–π –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ (summary_short, why_watch, quick_action, social_share, homework_20m), —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—è—Å—å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å—Ç–∏–ª—é –∏ –¥–ª–∏–Ω–µ.
3. –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ–ª—è : 
   - –°–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∏ –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –æ–±—ä—ë–º—É.
4. –°—Ñ–æ—Ä–º–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—ã–π JSON.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞:
{
  \"summary_short\": \"[–û–¥–Ω–æ —á—ë—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –≥–ª–∞–≤–Ω–æ–º –Ω–∞–≤—ã–∫–µ/–∑–Ω–∞–Ω–∏–∏]\",
  \"prev_lessons\": \"\",
  \"why_watch\": \"[400‚Äì600 –∑–Ω–∞–∫–æ–≤ –æ –ø–æ–ª—å–∑–µ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏]\",
  \"quick_action\": \"[–ú–∏–Ω–∏-–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Ç–µ–º—É]\",
  \"social_share\": \"[–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∑–∏—Å –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π]\",
  \"homework_20m\": \"[–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, ‚â§20 –º–∏–Ω]\"
}

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π placeholders ([–¢–ï–ö–°–¢ –¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–ò], [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞], [–æ—Å–Ω–æ–≤–Ω–∞—è –ø–æ–ª—å–∑–∞]) –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –ø—Ä–∏–≤–æ–¥–∏—à—å –ø—Ä–∏–º–µ—Ä.
- –£–¥–µ–ª–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç–∏, —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–æ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ—Å—Ç–∏ –≤—ã–≤–æ–¥–∞.
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã, —É–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è:
$transcript";

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://api.openai.com/v1/chat/completions');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $config['apis']['openai']['api_key']
    ]);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode([
        'model' => 'gpt-4o-mini',
        'messages' => [
            ['role' => 'user', 'content' => $prompt]
        ],
        'temperature' => 0.3,
        'max_tokens' => 2000
    ]));
    curl_setopt($ch, CURLOPT_TIMEOUT, 120);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200) {
        throw new Exception("–û—à–∏–±–∫–∞ API OpenAI: HTTP $httpCode - $response");
    }
    
    $data = json_decode($response, true);
    if (!isset($data['choices'][0]['message']['content'])) {
        throw new Exception("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API OpenAI");
    }
    
    $content = $data['choices'][0]['message']['content'];
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    if (preg_match('/\{.*\}/s', $content, $matches)) {
        $json = json_decode($matches[0], true);
        if ($json) {
            return $json;
        }
    }
    
    throw new Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ API");
}
?>


