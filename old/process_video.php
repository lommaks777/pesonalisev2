<?php
/**
 * Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð²Ð¸Ð´ÐµÐ¾ Ñ Kinescope
 * Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð²Ð¸Ð´ÐµÐ¾, Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ Ð°ÑƒÐ´Ð¸Ð¾, Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð¸Ñ€ÑƒÐµÑ‚ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ
 */

error_reporting(E_ALL);
ini_set('display_errors', 1);
set_time_limit(0);

require_once __DIR__ . '/utils.php';
require_once __DIR__ . '/kinescope_api.php';
require_once __DIR__ . '/whisper_api.php';
require_once __DIR__ . '/queue_system.php';

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
function sanitizeFilename($filename) {
    return preg_replace('/[^a-zA-Z0-9_\-\.]/', '_', $filename);
}

echo "=== ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ Ð’Ð˜Ð”Ð•Ðž Ð¡ KINESCOPE ===\n\n";

// ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
$options = getopt('', ['url:', 'lesson:', 'course:', 'quality:', 'help']);

if (isset($options['help']) || !isset($options['url'])) {
    echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:\n";
    echo "php process_video.php --url=https://kinescope.io/VIDEO_ID --lesson=1 --course='ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÑƒÑ€ÑÐ°' [--quality=360p]\n\n";
    echo "ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:\n";
    echo "  --url=URL        Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð²Ð¸Ð´ÐµÐ¾ Kinescope\n";
    echo "  --lesson=N       ÐÐ¾Ð¼ÐµÑ€ ÑƒÑ€Ð¾ÐºÐ°\n";
    echo "  --course=NAME    ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÑƒÑ€ÑÐ°\n";
    echo "  --quality=QUAL   ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð¸Ð´ÐµÐ¾ (360p, 720p, 1080p) - Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 360p\n";
    echo "  --help           ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n\n";
    echo "ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:\n";
    echo "php process_video.php --url=https://kinescope.io/202339654 --lesson=1 --course='ÐœÐ°ÑÑÐ°Ð¶ Ð¨Ð’Ð—'\n";
    echo "php process_video.php --url=https://kinescope.io/5NRs6UHWgMX9RtHqxNGy8j --lesson=2 --course='ÐœÐ°ÑÑÐ°Ð¶ Ð¨Ð’Ð—' --quality=720p\n";
    exit(0);
}

$videoUrl = $options['url'];
$lessonNumber = $options['lesson'];
$courseName = $options['course'];
$quality = $options['quality'] ?? '360p';

echo "ðŸ“¹ URL Ð²Ð¸Ð´ÐµÐ¾: $videoUrl\n";
echo "ðŸ“š ÐÐ¾Ð¼ÐµÑ€ ÑƒÑ€Ð¾ÐºÐ°: $lessonNumber\n";
echo "ðŸŽ“ ÐšÑƒÑ€Ñ: $courseName\n";
echo "ðŸ“º ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾: $quality\n\n";

try {
    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ API
    $config = cfg();
    $kinescope = new KinescopeAPI($config['apis']['kinescope']['api_key']);
    $whisper = new WhisperAPI($config['apis']['whisper']['api_key']);
    
    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ID Ð²Ð¸Ð´ÐµÐ¾ Ð¸Ð· URL
    $videoId = $kinescope->extractVideoId($videoUrl);
    if (!$videoId) {
        throw new Exception("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ ID Ð²Ð¸Ð´ÐµÐ¾ Ð¸Ð· URL: $videoUrl");
    }
    
    echo "ðŸ†” ID Ð²Ð¸Ð´ÐµÐ¾: $videoId\n";
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð²Ð¸Ð´ÐµÐ¾
    echo "ðŸ“Š ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð²Ð¸Ð´ÐµÐ¾...\n";
    $videoInfo = $kinescope->getVideoInfo($videoId);
    echo "ðŸ“ ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: " . $videoInfo['title'] . "\n";
    echo "â±ï¸  Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: " . round($videoInfo['duration'] / 60, 2) . " Ð¼Ð¸Ð½\n";
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÐºÑƒÑ€ÑÐ°
    $courseDir = __DIR__ . '/store/' . sanitizeFilename($courseName);
    if (!is_dir($courseDir)) {
        mkdir($courseDir, 0755, true);
        echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¿Ð°Ð¿ÐºÐ° ÐºÑƒÑ€ÑÐ°: $courseDir\n";
    }
    
    // Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾
    echo "â¬‡ï¸  Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ $quality...\n";
    $videoFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '.mp4';
    
    $downloadInfo = $kinescope->getVideoDownloadUrl($videoId, $quality);
    $downloadedSize = $kinescope->downloadVideoWithRetry($downloadInfo['url'], $videoFile);
    
    if (!$downloadedSize || $downloadedSize < 1024) {
        throw new Exception("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾");
    }
    
    echo "âœ… Ð’Ð¸Ð´ÐµÐ¾ ÑÐºÐ°Ñ‡Ð°Ð½Ð¾: " . round($downloadedSize / 1024 / 1024, 2) . " MB\n";
    
    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾
    echo "ðŸŽµ Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾...\n";
    $audioFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '.wav';
    
    $audioExtracted = $whisper->extractAudio($videoFile, $audioFile);
    if (!$audioExtracted) {
        throw new Exception("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð°ÑƒÐ´Ð¸Ð¾");
    }
    
    echo "âœ… ÐÑƒÐ´Ð¸Ð¾ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¾: " . round(filesize($audioFile) / 1024 / 1024, 2) . " MB\n";
    
    // Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð¸Ñ€ÑƒÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾
    echo "ðŸŽ¤ Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð¸Ñ€ÑƒÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾...\n";
    $transcript = $whisper->transcribe($audioFile);
    
    if (!$transcript) {
        throw new Exception("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸");
    }
    
    echo "âœ… Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: " . strlen($transcript) . " ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n";
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸ÑŽ
    $transcriptFile = $courseDir . '/' . sprintf('%02d', $lessonNumber) . '-' . $videoId . '.txt';
    file_put_contents($transcriptFile, $transcript);
    echo "ðŸ’¾ Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð°: $transcriptFile\n";
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ°
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ°...\n";
    $description = createLessonDescription($transcript, $lessonNumber, $courseName);
    
    if (!$description) {
        throw new Exception("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ ÑƒÑ€Ð¾ÐºÐ°");
    }
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ
    $descriptionFile = $courseDir . '/' . $lessonNumber . '-' . $videoId . '-final.json';
    file_put_contents($descriptionFile, json_encode($description, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
    echo "âœ… ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾: $descriptionFile\n";
    
    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    if (file_exists($videoFile)) {
        unlink($videoFile);
        echo "ðŸ—‘ï¸  Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾\n";
    }
    
    if (file_exists($audioFile)) {
        unlink($audioFile);
        echo "ðŸ—‘ï¸  Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð°ÑƒÐ´Ð¸Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾\n";
    }
    
    echo "\nðŸŽ‰ ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!\n";
    echo "ðŸ“„ Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ñ: $transcriptFile\n";
    echo "ðŸ“‹ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: $descriptionFile\n";
    
} catch (Exception $e) {
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: " . $e->getMessage() . "\n";
    exit(1);
}

/**
 * Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
 */
function createLessonDescription($transcript, $lessonNumber, $courseName) {
    $config = cfg();
    
    $prompt = "Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½ÑƒÑŽ, ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ (Â«Ñ€Ñ‹Ð±ÑƒÂ») ÑƒÑ€Ð¾ÐºÐ° Ð¿Ð¾ Ð¼Ð°ÑÑÐ°Ð¶Ñƒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð°Ñ†Ð¸Ð¸, ÑÐ¾Ð±Ð»ÑŽÐ´Ð°Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚:

- ÐžÑÐ½Ð¾Ð²Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÑ…Ð¾Ð´Ð½Ð°Ñ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð°Ñ†Ð¸Ñ, Ð½Ð¸ÐºÐ°ÐºÐ¸Ñ… Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸Ð»Ð¸ Ð²Ñ‹Ð´ÑƒÐ¼Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ð².
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹, ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ Ð±ÐµÐ· ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð»Ð¸ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ°, Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð¾Ð² Ð¸Ð· Ð¶Ð¸Ð·Ð½Ð¸, Ð±ÐµÐ· Ñ„Ñ€Ð°Ð· Ð²Ñ€Ð¾Ð´Ðµ Â«Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑ€Ð¾ÐºÐµÂ».
- Ð’ Ð¿Ð¾Ð»ÑÑ… Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‡Ñ‘Ñ‚ÐºÐ¸Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸, ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð¸ÐºÑƒ Ð¸ ÑÐ¾Ð±Ð»ÑŽÐ´Ð°Ð¹ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐ¼.
- ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð² Ð²Ð¸Ð´Ðµ JSON ÐºÐ°Ðº Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ð¾ Ð½Ð¸Ð¶Ðµ, Ð‘Ð•Ð— HTML, ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ð¸Ð»Ð¸ Ð¼Ð°Ñ€ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ ÐºÐ¾Ð´Ð°.

ÐŸÐ¾Ð»Ñ Ð¸ Ð¸Ñ… Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ:
- \"summary_short\": ÐžÐ´Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (12â€“18 ÑÐ»Ð¾Ð²) Ð¾ ÑÑƒÑ‚Ð¸ Ð½Ð°Ð²Ñ‹ÐºÐ°/Ð·Ð½Ð°Ð½Ð¸Ñ Ð¸Ð· ÑÑ‚Ð¾Ð³Ð¾ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð²Ð²Ð¾Ð´Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð¸Ð»Ð¸ ÑÐ»Ð¾Ð²Ð¾ÑÐ¾Ñ‡ÐµÑ‚Ð°Ð½Ð¸Ñ Ð²Ñ€Ð¾Ð´Ðµ Â«Ð² ÑÑ‚Ð¾Ð¼ ÑƒÑ€Ð¾ÐºÐµÂ», Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ.
- \"prev_lessons\": ÐžÑÑ‚Ð°Ð²ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ (\"\"), ÐµÑÐ»Ð¸ ÑƒÑ€Ð¾Ðº Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹ Ð¸Ð»Ð¸ Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÑÐ²ÑÐ·Ð¸ Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼Ð¸.
- \"why_watch\": 400â€“600 Ð·Ð½Ð°ÐºÐ¾Ð² Ð¾ ÑÑ€Ð¾Ñ‡Ð½Ð¾Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ðµ Ð¸ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸: ÐºÐ°ÐºÑƒÑŽ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ñ€ÐµÑˆÐ°ÐµÑ‚, ÐºÐ°Ðº Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¿Ð¾Ð»ÑŒÐ·Ñƒ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¸ Ð¿ÐµÑ€ÑÐ¿ÐµÐºÑ‚Ð¸Ð²Ñ‹ Ð½Ð° Ð±ÑƒÐ´ÑƒÑ‰ÐµÐµ.
- \"quick_action\": ÐžÐ´Ð½Ð° Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°/Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸Ñ‘Ð¼ Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð·Ð° 1â€“2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹, Ñ‡ÐµÑ‚ÐºÐ¾, Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ñ€Ð°ÑÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ð¹.
- \"social_share\": ÐžÑ‡ÐµÐ½ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹, Ð½Ð¾ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¸ Ð»Ñ‘Ð³ÐºÐ¸Ð¹ Ñ‚ÐµÐºÑÑ‚ (Ð±ÐµÐ· ÑˆÑ‚Ð°Ð¼Ð¿Ð¾Ð² Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¼Ð¾Ð²), Ð¿ÐµÑ€ÐµÐ´Ð°ÑŽÑ‰Ð¸Ð¹ Ð¸Ð½ÑÐ°Ð¹Ñ‚/Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð·Ð½Ð°Ð½Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ Ð·Ð°Ñ…Ð¾Ñ‡ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð² Instagram/Telegram.
- \"homework_20m\": ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ðµ, Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÐµÐ¼Ð¾Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ, Ñ€Ð°Ð·Ð±Ð¸Ñ‚Ð¾Ðµ Ð½Ð° Ñ‡ÐµÑ‚ÐºÐ¸Ðµ Ð¿Ð¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ (Ð´Ð¾ 20 Ð¼Ð¸Ð½ÑƒÑ‚ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸).

ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð¸ Ð¼ÐµÑ‚Ð¾Ð´:
1. Ð’Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð°Ñ†Ð¸ÑŽ: Ð²Ñ‹Ð¿Ð¸ÑˆÐ¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹, Ð¿Ñ€Ð¸Ñ‘Ð¼Ñ‹, Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸Ð»Ð¸ Â«Ð±Ð¾Ð»Ð¸Â» Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸.
2. ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ (ÑˆÐ°Ð³ Ð·Ð° ÑˆÐ°Ð³Ð¾Ð¼) Ð²Ñ‹Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð±Ð»Ð¾ÐºÐ° (summary_short, why_watch, quick_action, social_share, homework_20m), ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑÑÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ðº ÑÑ‚Ð¸Ð»ÑŽ Ð¸ Ð´Ð»Ð¸Ð½Ðµ.
3. ÐŸÐµÑ€ÐµÐ¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»Ñ : 
   - Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹, Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¸ Ð½Ðµ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚.
   - Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ Ð¸ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ Ð¾Ð±ÑŠÑ‘Ð¼Ñƒ.
4. Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ JSON.

Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð²Ñ‹Ð²Ð¾Ð´Ð°:
{
  \"summary_short\": \"[ÐžÐ´Ð½Ð¾ Ñ‡Ñ‘Ñ‚ÐºÐ¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¼ Ð½Ð°Ð²Ñ‹ÐºÐµ/Ð·Ð½Ð°Ð½Ð¸Ð¸]\",
  \"prev_lessons\": \"\",
  \"why_watch\": \"[400â€“600 Ð·Ð½Ð°ÐºÐ¾Ð² Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ðµ Ð¸ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸]\",
  \"quick_action\": \"[ÐœÐ¸Ð½Ð¸-Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½Ð° Ñ‚ÐµÐ¼Ñƒ]\",
  \"social_share\": \"[ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ñ‚ÐµÐ·Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ñ†ÑÐµÑ‚ÐµÐ¹]\",
  \"homework_20m\": \"[ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸, â‰¤20 Ð¼Ð¸Ð½]\"
}

Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ:
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ placeholders ([Ð¢Ð•ÐšÐ¡Ð¢ Ð¢Ð ÐÐÐ¡ÐšÐ Ð˜Ð‘ÐÐ¦Ð˜Ð˜], [ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð°Ñ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°], [Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð°]) Ð´Ð»Ñ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð², ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð²Ð¾Ð´Ð¸ÑˆÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÑ€.
- Ð£Ð´ÐµÐ»Ð¸ Ð¾ÑÐ¾Ð±Ð¾Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ‚Ð¸, Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸, Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð¾Ð², ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹Ð²Ð¾Ð´Ð°.
- Ð•ÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð°Ñ†Ð¸Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ñ‹, ÑƒÐºÐ°Ð¶Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€Ð½Ð¾ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚.

Ð¢Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð±Ð°Ñ†Ð¸Ñ:
$transcript";

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://api.openai.com/v1/chat/completions');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $config['apis']['openai']['api_key']
    ]);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode([
        'model' => 'gpt-4o-mini',
        'messages' => [
            ['role' => 'user', 'content' => $prompt]
        ],
        'temperature' => 0.3,
        'max_tokens' => 2000
    ]));
    curl_setopt($ch, CURLOPT_TIMEOUT, 120);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200) {
        throw new Exception("ÐžÑˆÐ¸Ð±ÐºÐ° API OpenAI: HTTP $httpCode - $response");
    }
    
    $data = json_decode($response, true);
    if (!isset($data['choices'][0]['message']['content'])) {
        throw new Exception("ÐÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ API OpenAI");
    }
    
    $content = $data['choices'][0]['message']['content'];
    
    // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ JSON Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    if (preg_match('/\{.*\}/s', $content, $matches)) {
        $json = json_decode($matches[0], true);
        if ($json) {
            return $json;
        }
    }
    
    throw new Exception("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ JSON Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð° API");
}
?>


