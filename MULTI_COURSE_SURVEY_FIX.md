# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ò–ù –ø—Ä–æ—Ñ–∏–ª—å
- –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∫—É—Ä—Å–∞ - –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ –∫—É—Ä—Å–∞ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—É—Ä—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 21179358:
- –ó–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É –¥–ª—è –∫—É—Ä—Å–∞ "–ú–∞—Å—Å–∞–∂ –®–í–ó" ‚úÖ
- –ó–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É –¥–ª—è –∫—É—Ä—Å–∞ "–ö–∏–Ω–µ–∑–∏–æ—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ" ‚ùå
  ‚Üí –î–∞–Ω–Ω—ã–µ –º–∞—Å—Å–∞–∂–∞ –±—ã–ª–∏ –ü–û–¢–ï–†–Ø–ù–´!
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–ù–ï–°–ö–û–õ–¨–ö–û –ø—Ä–æ—Ñ–∏–ª–µ–π** (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫—É—Ä—Å)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á: `(user_identifier + course_slug)`
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∫–µ—Ç—ã –¥–ª—è –¢–û–ì–û –ñ–ï –∫—É—Ä—Å–∞ - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–ª—è –ù–û–í–û–ì–û –∫—É—Ä—Å–∞ - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Supabase Dashboard**: https://supabase.com/dashboard
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor** (—Å–ª–µ–≤–∞ –≤ –º–µ–Ω—é)
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ [`/migrations/003_fix_multi_course_profiles.sql`](./migrations/003_fix_multi_course_profiles.sql)
6. –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ Ctrl+Enter)

**SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
```sql
-- Migration 003: Fix multi-course profile support
-- Allow users to have separate profiles for different courses

-- 1. Drop old unique constraint on user_identifier
ALTER TABLE profiles DROP CONSTRAINT IF EXISTS profiles_user_identifier_key;

-- 2. Add composite unique constraint on (user_identifier, course_slug)
-- This allows one user to have multiple profiles - one per course
ALTER TABLE profiles 
ADD CONSTRAINT profiles_user_course_unique 
UNIQUE (user_identifier, course_slug);

-- 3. Make course_slug NOT NULL (it's required for the composite key)
ALTER TABLE profiles 
ALTER COLUMN course_slug SET NOT NULL;

-- 4. Add index for faster lookups
CREATE INDEX IF NOT EXISTS idx_profiles_user_course 
ON profiles(user_identifier, course_slug);

-- 5. Add comment for documentation
COMMENT ON CONSTRAINT profiles_user_course_unique ON profiles IS 
'Each user can have one profile per course. When a user fills out a survey for a new course, a new profile is created. When re-filling for the same course, the existing profile is updated.';
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
SELECT 
  conname AS constraint_name,
  contype AS constraint_type,
  pg_get_constraintdef(oid) AS definition
FROM pg_constraint
WHERE conrelid = 'profiles'::regclass
  AND conname LIKE '%user%';
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
constraint_name: profiles_user_course_unique
constraint_type: u (unique)
definition: UNIQUE (user_identifier, course_slug)
```

### –®–∞–≥ 3: –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å 21179358 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 21179358 —Å–æ–¥–µ—Ä–∂–∏—Ç **–∞–Ω–∫–µ—Ç—É –¥–ª—è –º–∞—Å—Å–∞–∂–∞**, –Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ **–∫—É—Ä—Å—É —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è**. –ù—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:

```sql
DELETE FROM profiles WHERE user_identifier = '21179358';
```

–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (cascade delete).

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∫–µ—Ç—ã –¥–ª—è –¥–≤—É—Ö –∫—É—Ä—Å–æ–≤

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: uid=123456, name="–ú–∞—Ä–∏—è"

1. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∫–µ—Ç—É –¥–ª—è "–ú–∞—Å—Å–∞–∂ –®–í–ó":
   ‚Üí –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å:
     user_identifier: "123456"
     course_slug: "massazh-shvz"
     name: "–ú–∞—Ä–∏—è"
     survey: { motivation: [...], target_clients: "..." }

2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∫–µ—Ç—É –¥–ª—è "–ö–∏–Ω–µ–∑–∏–æ—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ":
   ‚Üí –°–æ–∑–¥–∞–µ—Ç—Å—è –ù–û–í–´–ô –ø—Ä–æ—Ñ–∏–ª—å:
     user_identifier: "123456"
     course_slug: "kinesio2"
     name: "–ú–∞—Ä–∏—è"
     survey: { ... –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ ... }

3. –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–Ω–∫–µ—Ç—É –¥–ª—è "–ú–∞—Å—Å–∞–∂ –®–í–ó":
   ‚Üí –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å (123456 + massazh-shvz)
```

### –ü—Ä–∏–º–µ—Ä 2: –í—Å—Ç–∞–≤–∫–∞ –∞–Ω–∫–µ—Ç—ã –≤ GetCourse

**–î–ª—è –∫—É—Ä—Å–∞ "–ú–∞—Å—Å–∞–∂ –®–í–ó":**
```html
<iframe 
  src="https://pesonalisev2-zxby.vercel.app/survey/iframe?uid={uid}&name={real_name}&course=massazh-shvz" 
  style="width:100%;height:1200px;border:0;">
</iframe>
```

**–î–ª—è –∫—É—Ä—Å–∞ "–ö–∏–Ω–µ–∑–∏–æ—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ":**
```html
<iframe 
  src="https://pesonalisev2-zxby.vercel.app/survey/iframe?uid={uid}&name={real_name}&course=kinesio2" 
  style="width:100%;height:1200px;border:0;">
</iframe>
```

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ:** –ø–∞—Ä–∞–º–µ—Ç—Ä `course=` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### API `/api/survey` (POST)

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "user_id": "123456",
  "name": "–ú–∞—Ä–∏—è",
  "course": "kinesio2",
  "survey": { ... }
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ò—â–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ `(user_id=123456 AND course=kinesio2)`
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí **–æ–±–Ω–æ–≤–ª—è–µ—Ç** –¥–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã
3. –ï—Å–ª–∏ –ù–ï –Ω–∞–π–¥–µ–Ω ‚Üí **—Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π** –ø—Ä–æ—Ñ–∏–ª—å

### API `/api/persona/block` (POST)

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "user_id": "123456",
  "lesson": "1",
  "course": "kinesio2"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ò—â–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ `(user_id=123456 AND course=kinesio2)`
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π** –∫–æ–Ω—Ç–µ–Ω—Ç
3. –ï—Å–ª–∏ –ù–ï –Ω–∞–π–¥–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π** –∫–æ–Ω—Ç–µ–Ω—Ç

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```sql
SELECT 
  user_identifier,
  course_slug,
  name,
  created_at
FROM profiles
WHERE user_identifier = '123456'
ORDER BY created_at DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:

```sql
SELECT 
  p.user_identifier,
  p.course_slug,
  p.name,
  COUNT(pld.id) as personalizations_count
FROM profiles p
LEFT JOIN personalized_lesson_descriptions pld ON p.id = pld.profile_id
WHERE p.user_identifier = '123456'
GROUP BY p.id, p.user_identifier, p.course_slug, p.name;
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **course_slug –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ñ–∏–ª—å –î–û–õ–ñ–ï–ù –∏–º–µ—Ç—å course_slug
2. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ò–ù –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ –∫—É—Ä—Å
3. **–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** - –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –≤—Å–µ –µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–æ–∂–µ —É–¥–∞–ª—è—é—Ç—Å—è
4. **–†–∞–∑–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—É—Ä—Å–æ–≤** - –≤ –±—É–¥—É—â–µ–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã –∞–Ω–∫–µ—Ç –¥–ª—è –º–∞—Å—Å–∞–∂–∞ –∏ —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
2. ‚úÖ –£–¥–∞–ª–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å 21179358
3. üî≤ –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É –∞–Ω–∫–µ—Ç—ã –¥–ª—è –∫—É—Ä—Å–∞ —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è
4. üî≤ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è GPT —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è
5. üî≤ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫—É—Ä—Å–∞ kinesio2

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å –∞–Ω–∫–µ—Ç—ã –¥–ª—è –ù–ï–°–ö–û–õ–¨–ö–ò–• –∫—É—Ä—Å–æ–≤
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –Ω–æ–≤—ã–π –∫—É—Ä—Å
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Ä—Å–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ –Ω–æ–≤—ã–µ –∫—É—Ä—Å—ã
