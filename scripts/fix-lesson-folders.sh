#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –ø–∞–ø–æ–∫ —É—Ä–æ–∫–æ–≤ –≤ store/shvz/lessons/
# –ù–æ–º–µ—Ä –ø–∞–ø–∫–∏ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å lesson.number –≤ lesson.json

set -e

LESSONS_DIR="/Users/aleksejlomakin/Documents/persona/store/shvz/lessons"
TEMP_DIR="${LESSONS_DIR}_temp_rename"

echo "üîÑ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–∞–ø–æ–∫ —É—Ä–æ–∫–æ–≤..."
echo ""

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p "$TEMP_DIR"

# –ü–ª–∞–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:
# –ü–∞–ø–∫–∞ ‚Üí –ù–æ–≤–æ–µ –∏–º—è (–Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞)
# 01 ‚Üí 05
# 02 ‚Üí 11
# 03 ‚Üí 04
# 04 ‚Üí 02 ‚≠ê (—ç—Ç–æ —É—Ä–æ–∫ –ø—Ä–æ –º—ã—à—Ü—ã!)
# 05 ‚Üí 01
# 06 ‚Üí 06 (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
# 07 ‚Üí 08
# 08 ‚Üí 07
# 09 ‚Üí 10
# 10 ‚Üí 09
# 11 ‚Üí 12
# 12 ‚Üí 03

echo "üìã –ü–ª–∞–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:"
echo "  01 ‚Üí 05 (5 –£—Ä–æ–∫ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)"
echo "  02 ‚Üí 11 (–ü–æ—Å—Ç–∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è)"
echo "  03 ‚Üí 04 (–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏)"
echo "  04 ‚Üí 02 ‚≠ê (–ú—ã—à—Ü—ã –®–í–ó - –ò–°–ü–†–ê–í–õ–Ø–ï–ú!)"
echo "  05 ‚Üí 01 (–í–≤–µ–¥–µ–Ω–∏–µ)"
echo "  06 ‚Üí 06 (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)"
echo "  07 ‚Üí 08 (2 –£—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ –∑–∞ –º–Ω–æ–π)"
echo "  08 ‚Üí 07 (2 —É—Ä–æ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)"
echo "  09 ‚Üí 10 (3 –£—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ –∑–∞ –º–Ω–æ–π)"
echo "  10 ‚Üí 09 (3 —É—Ä–æ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)"
echo "  11 ‚Üí 12 (4 —É—Ä–æ–∫-–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)"
echo "  12 ‚Üí 03 (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)"
echo ""

# –®–∞–≥ 1: –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–∞–ø–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
echo "üì¶ –®–∞–≥ 1: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."

for old_dir in "$LESSONS_DIR"/*/; do
  old_name=$(basename "$old_dir")
  
  # –ß–∏—Ç–∞–µ–º –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ –∏–∑ lesson.json
  lesson_number=$(cat "$old_dir/lesson.json" | grep '"number"' | grep -o '[0-9]*' | head -1)
  
  # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Å –≤–µ–¥—É—â–∏–º –Ω—É–ª—ë–º
  new_name=$(printf "%02d" "$lesson_number")
  
  echo "  $old_name ‚Üí $new_name"
  cp -r "$old_dir" "$TEMP_DIR/$new_name"
done

echo ""
echo "‚úÖ –®–∞–≥ 1 –∑–∞–≤–µ—Ä—à—ë–Ω"
echo ""

# –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–∞–ø–∫–∏
echo "üóëÔ∏è  –®–∞–≥ 2: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞–ø–æ–∫..."
rm -rf "$LESSONS_DIR"/*
echo "‚úÖ –®–∞–≥ 2 –∑–∞–≤–µ—Ä—à—ë–Ω"
echo ""

# –®–∞–≥ 3: –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø–∞–ø–∫–∏ –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ
echo "üì• –®–∞–≥ 3: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–∞–ø–æ–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏..."
mv "$TEMP_DIR"/* "$LESSONS_DIR/"
rmdir "$TEMP_DIR"
echo "‚úÖ –®–∞–≥ 3 –∑–∞–≤–µ—Ä—à—ë–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
echo ""
for dir in "$LESSONS_DIR"/*/; do
  dirname=$(basename "$dir")
  number=$(cat "$dir/lesson.json" | grep '"number"' | grep -o '[0-9]*')
  title=$(cat "$dir/lesson.json" | grep '"title"' | cut -d'"' -f4 | head -c 60)
  
  if [ "$dirname" = "$(printf "%02d" "$number")" ]; then
    echo "‚úÖ –ü–∞–ø–∫–∞ $dirname = –£—Ä–æ–∫ ‚Ññ$number: $title"
  else
    echo "‚ùå –ü–∞–ø–∫–∞ $dirname ‚â† –£—Ä–æ–∫ ‚Ññ$number: $title"
  fi
done

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫–∏ –≤ –ë–î"
echo ""
echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "  npx tsx --env-file=.env.local scripts/import-lessons.ts"
