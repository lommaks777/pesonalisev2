/**
 * Test Script: Verify New Personalization Engine
 * 
 * Tests the new direct-from-transcript personalization generation
 * for a single lesson to validate the complete workflow.
 */

import "dotenv/config";
import { createClient } from "@supabase/supabase-js";
import { getOpenAIClient } from "../lib/services/openai";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

interface SurveyData {
  motivation?: string[];
  target_clients?: string;
  skills_wanted?: string;
  fears?: string[];
  wow_result?: string;
  practice_model?: string;
}

interface LessonMetadata {
  lesson_number: number;
  title: string;
}

function createPersonalizationPrompt(
  transcript: string,
  lessonMetadata: LessonMetadata,
  survey: SurveyData,
  userName: string
): string {
  return `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –º–µ—Ç–æ–¥–æ–ª–æ–≥ –∫—É—Ä—Å–∞ –º–∞—Å—Å–∞–∂–∞ –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –ì–õ–£–ë–û–ö–û –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–û–ï –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–Ω–æ–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤–∏–¥–µ–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∫–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –£–†–û–ö–ï:
–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞: ${lessonMetadata.lesson_number}
–ù–∞–∑–≤–∞–Ω–∏–µ: ${lessonMetadata.title}

–ü–û–õ–ù–ê–Ø –†–ê–°–®–ò–§–†–û–í–ö–ê –£–†–û–ö–ê (${transcript.length} —Å–∏–º–≤–æ–ª–æ–≤):
${transcript.substring(0, 15000)}${transcript.length > 15000 ? "..." : ""}

–ê–ù–ö–ï–¢–ê –°–¢–£–î–ï–ù–¢–ê:
- –ò–º—è: ${userName}
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è: ${survey.motivation?.join(", ") || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –¶–µ–ª–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: ${survey.target_clients || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –ñ–µ–ª–∞–µ–º—ã–µ –Ω–∞–≤—ã–∫–∏: ${survey.skills_wanted || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –°—Ç—Ä–∞—Ö–∏/–æ–ø–∞—Å–µ–Ω–∏—è: ${survey.fears?.join(", ") || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –ñ–µ–ª–∞–µ–º—ã–π wow-—Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${survey.wow_result || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –ú–æ–¥–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏: ${survey.practice_model || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}

–ó–ê–î–ê–ù–ò–ï:
–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ö–û–ù–ö–†–ï–¢–ù–£–Æ –¶–ï–ù–ù–û–°–¢–¨ –¥–ª—è –≠–¢–û–ì–û —Å—Ç—É–¥–µ–Ω—Ç–∞.

–°–¢–†–£–ö–¢–£–†–ê –û–ü–ò–°–ê–ù–ò–Ø (7 —Ä–∞–∑–¥–µ–ª–æ–≤):

1. **introduction** (–í–≤–µ–¥–µ–Ω–∏–µ):
   - –û–±—Ä–∞—Ç–∏—Å—å –∫ —Å—Ç—É–¥–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏
   - –£–∫–∞–∂–∏ —Ü–µ–ª—å —É—Ä–æ–∫–∞ (–∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏)
   - –°–≤—è–∂–∏ —Å –∏—Ö –æ–∂–∏–¥–∞–µ–º—ã–º wow-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
   - 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

2. **why_it_matters_for_you** (–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å):
   - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É: –∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏/–∑–Ω–∞–Ω–∏—è —Ç–∞–º –¥–∞–Ω—ã
   - –ü–æ–∫–∞–∂–∏, –∫–∞–∫ –≠–¢–ò –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –ø–æ–º–æ–≥—É—Ç —Å –∏—Ö —Å—Ç—Ä–∞—Ö–∞–º–∏
   - –°–≤—è–∂–∏ —Å –∏—Ö —Ü–µ–ª–µ–≤—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
   - –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω–µ—Ç –∏—Ö –∫ wow-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
   - 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏

3. **key_takeaways** (–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã):
   - –ú–∞—Å—Å–∏–≤ –∏–∑ 3-4 –ø—É–Ω–∫—Ç–æ–≤
   - –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç - –ö–û–ù–ö–†–ï–¢–ù–´–ô –Ω–∞–≤—ã–∫/–∑–Ω–∞–Ω–∏–µ –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
   - –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞: "–í—ã —É–∑–Ω–∞–µ—Ç–µ/–Ω–∞—É—á–∏—Ç–µ—Å—å/–ø–æ–π–º—ë—Ç–µ..."
   - –ê–¥–∞–ø—Ç–∏—Ä—É–π –ø—Ä–∏–º–µ—Ä—ã –ø–æ–¥ —Ü–µ–ª–µ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–∞
   - –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚â§ 20 —Å–ª–æ–≤

4. **practical_application** (–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ):
   - –ö–∞–∫ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ç–µ—Ö–Ω–∏–∫–∏ –∏–∑ —É—Ä–æ–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –∏—Ö –º–æ–¥–µ–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏
   - –ü—Ä–∏–º–µ—Ä—ã —Å–∏—Ç—É–∞—Ü–∏–π —Å –∏—Ö —Ü–µ–ª–µ–≤—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ —Å–º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ —É—Ä–æ–∫–∞
   - 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

5. **addressing_fears** (–û—Ç–≤–µ—Ç –Ω–∞ –æ–ø–∞—Å–µ–Ω–∏—è):
   - –ü—Ä—è–º–æ –æ–±—Ä–∞—Ç–∏—Å—å –∫ –∏—Ö —Å—Ç—Ä–∞—Ö–∞–º –∏–∑ –∞–Ω–∫–µ—Ç—ã
   - –û–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ –ö–û–ù–ö–†–ï–¢–ù–´–ï –º–æ–º–µ–Ω—Ç—ã –∏–∑ —É—Ä–æ–∫–∞ –ø–æ–º–æ–≥—É—Ç –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —ç—Ç–∏ —Å—Ç—Ä–∞—Ö–∏
   - –£–∫–∞–∂–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
   - 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

6. **personalized_homework** (–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ):
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥ –∏—Ö –º–æ–¥–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏
   - –£—á–∏—Ç—ã–≤–∞–π –∏—Ö —É—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ –∏ —Ü–µ–ª–µ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º–æ–µ
   - 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

7. **motivational_quote** (–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞):
   - –°–≤—è–∂–∏ —Å –∏—Ö wow-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
   - –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ç–æ–Ω
   - 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

–ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ê:
‚úì –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞
‚úì –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å –º–∞—Å—Å–∞–∂—É" - –±—É–¥—å –ö–û–ù–ö–†–ï–¢–ï–ù
‚úì –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
‚úì –ö–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏–µ –∫–∞–∫ —É—Ä–æ–∫–∞, —Ç–∞–∫ –∏ –ø—Ä–æ—Ñ–∏–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
‚úì –Ø–∑—ã–∫: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ "–≤—ã"
‚úì –£—Ä–æ–≤–µ–Ω—å —è–∑—ã–∫–∞: B1-B2 (–ø–æ–Ω—è—Ç–Ω–æ –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
  "introduction": "—Å—Ç—Ä–æ–∫–∞",
  "why_it_matters_for_you": "—Å—Ç—Ä–æ–∫–∞",
  "key_takeaways": ["–ø—É–Ω–∫—Ç 1", "–ø—É–Ω–∫—Ç 2", "–ø—É–Ω–∫—Ç 3"],
  "practical_application": "—Å—Ç—Ä–æ–∫–∞",
  "addressing_fears": "—Å—Ç—Ä–æ–∫–∞",
  "personalized_homework": "—Å—Ç—Ä–æ–∫–∞",
  "motivational_quote": "—Å—Ç—Ä–æ–∫–∞"
}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`;
}

async function testPersonalizationEngine() {
  console.log("=== Testing New Personalization Engine ===\n");

  if (!SUPABASE_URL || !SUPABASE_KEY) {
    throw new Error("Missing Supabase credentials");
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // Test with lesson 1
  const testLessonNumber = 1;

  try {
    // 1. Get lesson from database
    console.log(`üìö Loading lesson ${testLessonNumber}...`);
    const { data: lesson, error: lessonError } = await supabase
      .from("lessons")
      .select("id, lesson_number, title, content")
      .eq("lesson_number", testLessonNumber)
      .single();

    if (lessonError || !lesson) {
      throw new Error(`Failed to load lesson: ${lessonError?.message || "Not found"}`);
    }

    console.log(`‚úÖ Loaded: ${lesson.title}`);
    console.log(`   Lesson ID: ${lesson.id}\n`);

    // 2. Load transcript
    console.log("üìÑ Loading transcript from database...");
    const transcriptContent = lesson.content as any;

    if (!transcriptContent || !transcriptContent.transcription) {
      throw new Error("Failed to load transcript");
    }

    const transcript = transcriptContent.transcription;

    console.log(`‚úÖ Transcript loaded: ${transcriptContent.transcription_length || transcript.length} characters\n`);

    // 3. Prepare test survey data
    const testSurvey: SurveyData = {
      motivation: ["–ù–∞—á–∞—Ç—å —Å–≤–æ—é –ø—Ä–∞–∫—Ç–∏–∫—É", "–ü–æ–º–æ–≥–∞—Ç—å –±–ª–∏–∑–∫–∏–º"],
      target_clients: "–î—Ä—É–∑—å—è –∏ —Å–µ–º—å—è",
      skills_wanted: "–†–µ–ª–∞–∫—Å–∞—Ü–∏–æ–Ω–Ω—ã–π –º–∞—Å—Å–∞–∂",
      fears: ["–°–¥–µ–ª–∞—Ç—å –±–æ–ª—å–Ω–æ –∫–ª–∏–µ–Ω—Ç—É", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞"],
      wow_result: "–£–≤–µ—Ä–µ–Ω–Ω–æ –¥–µ–ª–∞—Ç—å –º–∞—Å—Å–∞–∂ –±–ª–∏–∑–∫–∏–º –∏ –ø–æ–ª—É—á–∞—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å",
      practice_model: "–î–æ–º"
    };

    const testUserName = "–ú–∞—Ä–∏—è";

    console.log("üë§ Test User Profile:");
    console.log(`   Name: ${testUserName}`);
    console.log(`   Target clients: ${testSurvey.target_clients}`);
    console.log(`   Fears: ${testSurvey.fears?.join(", ")}`);
    console.log(`   Wow result: ${testSurvey.wow_result}\n`);

    // 4. Generate personalization
    console.log("ü§ñ Generating personalized description with GPT-4o...");
    console.log("   (This may take 10-15 seconds)\n");

    const startTime = Date.now();

    const lessonMetadata: LessonMetadata = {
      lesson_number: lesson.lesson_number,
      title: lesson.title
    };

    const prompt = createPersonalizationPrompt(transcript, lessonMetadata, testSurvey, testUserName);
    
    const openai = getOpenAIClient();
    
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: "–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –º–µ—Ç–æ–¥–æ–ª–æ–≥ –∫—É—Ä—Å–∞ –º–∞—Å—Å–∞–∂–∞ –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –°–æ–∑–¥–∞—ë—à—å –≥–ª—É–±–æ–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–∫–æ–≤. –û—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: 0.7,
      max_tokens: 2500,
      response_format: { type: "json_object" },
    });

    const content = completion.choices[0]?.message?.content || "{}";
    let cleanContent = content.trim();
    if (cleanContent.startsWith('```json')) {
      cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
    }
    if (cleanContent.startsWith('```')) {
      cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }

    const personalization = JSON.parse(cleanContent);

    const duration = ((Date.now() - startTime) / 1000).toFixed(2);

    console.log(`‚úÖ Personalization generated in ${duration}s\n`);

    // 5. Display results
    console.log("=== Generated Personalized Content ===\n");
    console.log(`üìù Introduction:\n${personalization.introduction}\n`);
    console.log(`üí° Why It Matters For You:\n${personalization.why_it_matters_for_you}\n`);
    console.log(`üéØ Key Takeaways:`);
    personalization.key_takeaways.forEach((item, i) => {
      console.log(`   ${i + 1}. ${item}`);
    });
    console.log();
    console.log(`üõ†Ô∏è Practical Application:\n${personalization.practical_application}\n`);
    console.log(`üõ°Ô∏è Addressing Fears:\n${personalization.addressing_fears}\n`);
    console.log(`üìö Personalized Homework:\n${personalization.personalized_homework}\n`);
    console.log(`‚ú® Motivational Quote:\n"${personalization.motivational_quote}"\n`);

    // 6. Quality checks
    console.log("=== Quality Validation ===");
    
    const checks = {
      "Has student name": personalization.introduction.includes(testUserName),
      "References fears": 
        personalization.addressing_fears.toLowerCase().includes("—Å—Ç—Ä–∞—Ö") ||
        personalization.addressing_fears.toLowerCase().includes("–æ–ø–∞—Å–µ–Ω") ||
        personalization.why_it_matters_for_you.toLowerCase().includes("–±–æ–ª—å–Ω–æ"),
      "References target clients": 
        personalization.practical_application.toLowerCase().includes("–¥—Ä—É–∑") ||
        personalization.practical_application.toLowerCase().includes("—Å–µ–º") ||
        personalization.practical_application.toLowerCase().includes("–±–ª–∏–∑"),
      "References wow result": 
        personalization.motivational_quote.toLowerCase().includes("—É–≤–µ—Ä–µ–Ω") ||
        personalization.introduction.toLowerCase().includes("—É–≤–µ—Ä–µ–Ω"),
      "Has 3+ key takeaways": personalization.key_takeaways.length >= 3,
      "All fields non-empty": 
        personalization.introduction.length > 0 &&
        personalization.why_it_matters_for_you.length > 0 &&
        personalization.practical_application.length > 0 &&
        personalization.addressing_fears.length > 0 &&
        personalization.personalized_homework.length > 0 &&
        personalization.motivational_quote.length > 0
    };

    let passedChecks = 0;
    Object.entries(checks).forEach(([check, passed]) => {
      console.log(`${passed ? "‚úÖ" : "‚ùå"} ${check}`);
      if (passed) passedChecks++;
    });

    const score = (passedChecks / Object.keys(checks).length * 100).toFixed(0);
    console.log(`\nüìä Quality Score: ${score}% (${passedChecks}/${Object.keys(checks).length} checks passed)\n`);

    if (passedChecks === Object.keys(checks).length) {
      console.log("üéâ All quality checks passed!");
    } else {
      console.log("‚ö†Ô∏è  Some quality checks failed. Review the output above.");
    }

  } catch (error) {
    console.error("\n‚ùå Test failed:", error);
    process.exit(1);
  }
}

// Run test
testPersonalizationEngine()
  .then(() => {
    console.log("\n‚úÖ Test completed successfully!");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\n‚ùå Test failed:", error);
    process.exit(1);
  });
