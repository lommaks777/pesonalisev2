<!DOCTYPE html>
<html lang="ru">
<div id="persona-lesson-2" 
     data-lesson="2" 
     data-title="ШВЗ Мышцы, с которыми мы будем работать в этом курсе" 
     style="display:none;margin:30px 0;">
</div>

<script>
(async function(){
  const API = "https://pesonalisev2-zxby.vercel.app/api/persona";
  const UID = "{uid}";
  const userId = UID && UID !== "{uid}" ? String(UID) : "guest";
  const mount = document.getElementById('persona-lesson-2');
  const lesson = mount.getAttribute('data-lesson'); // Теперь "2"
  const title = mount.getAttribute('data-title');

  try {
    // Загружаем стили один раз
    if (!document.querySelector('link[data-persona-styles]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://pesonalisev2-zxby.vercel.app/persona/styles.css';
      link.setAttribute('data-persona-styles', '1');
      document.head.appendChild(link);
    }

    const r = await fetch(`${API}/block`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        user_id: userId, 
        lesson: lesson,    // "2" вместо полного названия
        title: title, 
        flush: false 
      })
    });
    
    const data = await r.json();
    
    if (data?.ok && data?.html) {
      mount.innerHTML = data.html;
      mount.style.display = 'block';
    } else {
      console.warn('Персонализация недоступна:', data?.error || 'неизвестная ошибка');
    }
  } catch(e) {
    console.error('Persona block error:', e);
  }
})();
</script>
</body>
</html>
