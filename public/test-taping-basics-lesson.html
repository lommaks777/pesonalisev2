<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Taping Basics Lesson 1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-info {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .test-info h2 {
            margin-top: 0;
            color: #333;
        }
        .test-params {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        #persona-lesson-1 {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>üß™ Test: Taping Basics - Lesson 1</h2>
        <div class="test-params">
            <strong>Parameters:</strong><br>
            - course: taping-basics<br>
            - lesson: 1<br>
            - title: 1 –í–≤–µ–¥–µ–Ω–∏–µ<br>
            - user_id: guest<br>
            - API: https://pesonalisev2-zxby.vercel.app/api/persona/block
        </div>
    </div>

    <div id="persona-lesson-1" 
         data-lesson="1" 
         data-title="1 –í–≤–µ–¥–µ–Ω–∏–µ"
         data-course="taping-basics" 
         style="display:none;margin:30px 0;">
        <p>Loading...</p>
    </div>

    <script>
    (async function(){
      const API = "https://pesonalisev2-zxby.vercel.app/api/persona";
      const UID = "{uid}";
      const userId = UID && UID !== "{uid}" ? String(UID) : "guest";
      const mount = document.getElementById('persona-lesson-1');
      const lesson = mount.getAttribute('data-lesson');
      const title = mount.getAttribute('data-title');
      const course = mount.getAttribute('data-course');

      console.log('[Persona Debug] Parameters:', { userId, lesson, title, course });

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑
        if (!document.querySelector('link[data-persona-styles]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://pesonalisev2-zxby.vercel.app/persona/styles.css';
          link.setAttribute('data-persona-styles', '1');
          document.head.appendChild(link);
          console.log('[Persona] ‚úÖ Styles loaded');
        }

        console.log('[Persona] üîÑ Fetching content...');
        
        const requestBody = { 
          user_id: userId, 
          lesson: lesson,
          title: title,
          course: course, 
          flush: true
        };
        
        console.log('[Persona] Request body:', JSON.stringify(requestBody, null, 2));
        
        const r = await fetch(`${API}/block`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });
        
        console.log('[Persona] Response status:', r.status);
        
        const data = await r.json();
        console.log('[Persona] Response data:', data);
        
        if (data?.ok && data?.html) {
          mount.innerHTML = data.html;
          mount.style.display = 'block';
          console.log('[Persona] ‚úÖ Content loaded successfully');
          
          // Check if content mentions taping or massage
          const htmlText = data.html.toLowerCase();
          if (htmlText.includes('—Ç–µ–π–ø')) {
            console.log('[Persona] ‚úÖ CORRECT: Content is about TAPING');
          } else if (htmlText.includes('–º–∞—Å—Å–∞–∂')) {
            console.error('[Persona] ‚ùå ERROR: Content is about MASSAGE (wrong course!)');
          }
        } else {
          console.warn('[Persona] ‚ö†Ô∏è No content:', data?.error || 'unknown error');
          mount.innerHTML = '<p style="color: red;">Error: ' + (data?.error || 'Failed to load content') + '</p>';
          mount.style.display = 'block';
        }
      } catch(e) {
        console.error('[Persona] ‚ùå Exception:', e);
        mount.innerHTML = '<p style="color: red;">Exception: ' + e.message + '</p>';
        mount.style.display = 'block';
      }
    })();
    </script>
</body>
</html>
