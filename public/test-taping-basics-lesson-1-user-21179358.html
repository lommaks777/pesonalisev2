<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç: –£—Ä–æ–∫ 1 Taping-Basics –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 21179358</title>
    <link rel="stylesheet" href="/persona/styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .test-controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .test-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .test-success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .test-warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1976d2;
        }
        button.secondary {
            background: #757575;
        }
        button.secondary:hover {
            background: #616161;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        #debug-info {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        #result {
            margin-top: 20px;
        }
        .diagnostic-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .diagnostic-section h3 {
            margin-top: 0;
            color: #2196f3;
        }
        .status-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
            display: inline-block;
            min-width: 200px;
        }
        .status-value {
            color: #666;
        }
        .status-ok {
            color: #4caf50;
            font-weight: bold;
        }
        .status-error {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç: –£—Ä–æ–∫ 1 –∫—É—Ä—Å–∞ Taping-Basics</h1>
    
    <div class="test-info">
        <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ</h3>
        <p><strong>User ID:</strong> 21179358</p>
        <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> –ê–ª–µ–∫—Å–µ–π</p>
        <p><strong>–ö—É—Ä—Å:</strong> taping-basics</p>
        <p><strong>–£—Ä–æ–∫:</strong> 1 - –í–≤–µ–¥–µ–Ω–∏–µ</p>
    </div>

    <div class="diagnostic-section" id="diagnosticInfo">
        <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <div class="status-item">
            <span class="status-label">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–∏–ª—è:</span>
            <span class="status-value" id="profileStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã:</span>
            <span class="status-value" id="surveyStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–π —Å–æ–∑–¥–∞–Ω–æ:</span>
            <span class="status-value" id="personalizationCount">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —É—Ä–æ–∫–∞ 1:</span>
            <span class="status-value" id="transcriptionStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–ë–∞–∑–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ 1:</span>
            <span class="status-value" id="defaultDescStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>
    </div>

    <div class="test-controls">
        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <button onclick="runDiagnostics()">üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
        <button onclick="testPersonalization()">üß™ –¢–µ—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏</button>
        <button onclick="generatePersonalization()" class="secondary">‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é</button>
        <button onclick="showDebugInfo()" class="secondary">üìã Debug Info</button>
        <button onclick="clearResults()" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="statusMessage"></div>
    <div id="result"></div>
    <div id="debug-info" style="display: none;"></div>

    <script>
        const USER_ID = '21179358';
        const COURSE_SLUG = 'taping-basics';
        const LESSON_NUMBER = 1;
        let diagnosticData = null;
        let lastResponse = null;

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            setTimeout(() => {
                runDiagnostics();
            }, 500);
        };

        async function runDiagnostics() {
            console.log('üîç Running diagnostics...');
            
            // For now, we'll use the check script results
            // Run: npx tsx scripts/check-user-21179358.ts
            
            const mockData = {
                profile: {
                    id: '1ccb1f9f-d760-4c2b-bd76-13c9d4839c22',
                    user_identifier: '21179358',
                    name: '–ê–ª–µ–∫—Å–µ–π',
                    course_slug: 'taping-basics',
                    has_survey: true
                },
                survey: {
                    uid: '21179358',
                    course: 'taping-basics',
                    real_name: '–ê–ª–µ–∫—Å–µ–π'
                },
                personalizations: [],
                lesson: {
                    id: '86f9c6a7-4b43-4beb-a827-ad37a73b3a9b',
                    lesson_number: 1,
                    title: '1 –í–≤–µ–¥–µ–Ω–∏–µ',
                    has_transcription: false,
                    has_default_description: true,
                    transcription_length: 0
                }
            };
            
            diagnosticData = mockData;
            updateDiagnosticUI(mockData);
            
            console.log('Using mock diagnostic data. Run npx tsx scripts/check-user-21179358.ts for real data.');
        }

        function updateDiagnosticUI(data) {
            // Profile status
            const profileStatus = document.getElementById('profileStatus');
            if (data.profile) {
                profileStatus.innerHTML = `<span class="status-ok">‚úÖ –ù–∞–π–¥–µ–Ω (${data.profile.name})</span>`;
            } else {
                profileStatus.innerHTML = '<span class="status-error">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω</span>';
            }

            // Survey status
            const surveyStatus = document.getElementById('surveyStatus');
            if (data.profile?.survey) {
                const survey = data.profile.survey;
                surveyStatus.innerHTML = `<span class="status-ok">‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–∞</span> (–∫—É—Ä—Å: ${survey.course || '–Ω–µ —É–∫–∞–∑–∞–Ω'})`;
            } else {
                surveyStatus.innerHTML = '<span class="status-error">‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞</span>';
            }

            // Personalization count
            const persCount = document.getElementById('personalizationCount');
            const count = data.personalizations?.length || 0;
            if (count > 0) {
                persCount.innerHTML = `<span class="status-ok">‚úÖ ${count} —É—Ä–æ–∫–æ–≤</span>`;
            } else {
                persCount.innerHTML = '<span class="status-error">‚ùå 0 —É—Ä–æ–∫–æ–≤ (–Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å)</span>';
            }

            // Transcription status
            const transcriptionStatus = document.getElementById('transcriptionStatus');
            if (data.lesson?.transcription) {
                const length = data.lesson.transcription.length;
                transcriptionStatus.innerHTML = `<span class="status-ok">‚úÖ –ï—Å—Ç—å (${length} —Å–∏–º–≤–æ–ª–æ–≤)</span>`;
            } else {
                transcriptionStatus.innerHTML = '<span class="status-error">‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞!</span>';
            }

            // Default description status
            const defaultDescStatus = document.getElementById('defaultDescStatus');
            if (data.lesson?.default_description) {
                defaultDescStatus.innerHTML = '<span class="status-ok">‚úÖ –ï—Å—Ç—å</span>';
            } else {
                defaultDescStatus.innerHTML = '<span class="status-error">‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>';
            }

            // Show message about main issue
            const statusDiv = document.getElementById('statusMessage');
            if (!data.lesson?.transcription) {
                statusDiv.innerHTML = `
                    <div class="test-error">
                        <h3>‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞</h3>
                        <p><strong>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —É—Ä–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!</strong></p>
                        <p>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —É—Ä–æ–∫–∞. 
                        –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å).</p>
                        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –¥–ª—è —É—Ä–æ–∫–∞ 1 –∫—É—Ä—Å–∞ taping-basics.</p>
                    </div>
                `;
            } else if (count === 0) {
                statusDiv.innerHTML = `
                    <div class="test-warning">
                        <h3>‚ö†Ô∏è –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</h3>
                        <p>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –µ—Å—Ç—å, –Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞ –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞.</p>
                        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é" –∏–ª–∏ –≤—ã–∑–æ–≤–∏—Ç–µ API /api/persona/block</p>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="test-success">
                        <h3>‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ</h3>
                        <p>–ü—Ä–æ—Ñ–∏–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞. –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å!</p>
                    </div>
                `;
            }
        }

        async function testPersonalization() {
            const statusDiv = document.getElementById('statusMessage');
            const resultDiv = document.getElementById('result');
            
            statusDiv.innerHTML = '<div class="test-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–∫–∞...</div>';
            resultDiv.innerHTML = '';

            try {
                const requestBody = {
                    user_id: USER_ID,
                    lesson: LESSON_NUMBER.toString(),
                    title: `–£—Ä–æ–∫ ${LESSON_NUMBER}`
                };

                console.log('Sending request:', requestBody);

                const response = await fetch('/api/persona/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                lastResponse = { request: requestBody, response: data, status: response.status };

                console.log('Response received:', data);

                if (!response.ok) {
                    statusDiv.innerHTML = '<div class="test-error">‚ùå HTTP Error: ' + response.status + '</div>';
                    resultDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    return;
                }

                if (data.ok && data.html) {
                    const isDefault = data.html.includes('persona-default') || data.html.includes('–ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞');
                    const isPersonalized = !isDefault;

                    if (isPersonalized) {
                        statusDiv.innerHTML = '<div class="test-success">‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è!</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="test-warning">‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞ (–Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)</div>';
                    }

                    resultDiv.innerHTML = data.html;
                    analyzeContent(data.html);
                } else {
                    statusDiv.innerHTML = '<div class="test-error">‚ùå Invalid response: no HTML</div>';
                    resultDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="test-error">‚ùå Request error: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }

        async function generatePersonalization() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = '<div class="test-info">‚è≥ Generating personalization... This will take 10-30 seconds...</div>';

            try {
                const response = await fetch('/api/persona/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        lesson: LESSON_NUMBER.toString(),
                        course: COURSE_SLUG,
                        title: `–£—Ä–æ–∫ ${LESSON_NUMBER}`
                    })
                });

                const data = await response.json();

                if (response.ok && data.ok) {
                    statusDiv.innerHTML = '<div class="test-success">‚úÖ Request completed! Checking if personalization was generated...</div>';
                    
                    // Wait a moment then refresh diagnostics
                    setTimeout(() => {
                        runDiagnostics();
                        
                        // Show the result
                        if (data.html) {
                            const resultDiv = document.getElementById('result');
                            resultDiv.innerHTML = data.html;
                            
                            // Check if it's personalized
                            if (data.html.includes('introduction') || data.html.includes('–ê–ª–µ–∫—Å–µ–π')) {
                                statusDiv.innerHTML = '<div class="test-success">üéâ PERSONALIZATION GENERATED SUCCESSFULLY!</div>';
                            } else {
                                statusDiv.innerHTML = '<div class="test-warning">‚ö†Ô∏è Response received but may be default content</div>';
                            }
                        }
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="test-error">‚ùå Error: ' + JSON.stringify(data) + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="test-error">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function analyzeContent(html) {
            const statusDiv = document.getElementById('statusMessage');
            
            const sections = [];
            const regex = /<h3 class="persona-section-title">([^<]+)<\/h3>/g;
            let match;
            while ((match = regex.exec(html)) !== null) {
                sections.push(match[1].trim());
            }

            if (sections.length > 0) {
                statusDiv.innerHTML += '<div class="test-info"><strong>üìã –°–µ–∫—Ü–∏–∏:</strong><br>' + 
                    sections.map(s => '‚Ä¢ ' + s).join('<br>') + '</div>';
            }

            const hasName = html.includes('–ê–ª–µ–∫—Å–µ–π');
            const hasSurveyButton = html.includes('–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É');
            const isDefaultBadge = html.includes('–ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞');

            statusDiv.innerHTML += '<div class="test-info"><strong>üîç –ê–Ω–∞–ª–∏–∑:</strong><br>';
            statusDiv.innerHTML += '‚Ä¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–º–µ–Ω–∏: ' + (hasName ? '‚úÖ' : '‚ùå') + '<br>';
            statusDiv.innerHTML += '‚Ä¢ –ö–Ω–æ–ø–∫–∞ –∞–Ω–∫–µ—Ç—ã: ' + (hasSurveyButton ? '‚ö†Ô∏è –î–∞ (–±–∞–∑–æ–≤–∞—è)' : '‚úÖ –ù–µ—Ç') + '<br>';
            statusDiv.innerHTML += '‚Ä¢ –ë–µ–π–¥–∂ –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏: ' + (isDefaultBadge ? '‚ùå –î–∞' : '‚úÖ –ù–µ—Ç') + '<br>';
            statusDiv.innerHTML += '</div>';
        }

        function showDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            
            if (debugDiv.style.display === 'none') {
                const debugData = {
                    diagnostic: diagnosticData,
                    lastAPIResponse: lastResponse
                };
                debugDiv.textContent = JSON.stringify(debugData, null, 2);
                debugDiv.style.display = 'block';
            } else {
                debugDiv.style.display = 'none';
            }
        }

        function clearResults() {
            document.getElementById('statusMessage').innerHTML = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('debug-info').style.display = 'none';
            lastResponse = null;
        }
    </script>
</body>
</html>
