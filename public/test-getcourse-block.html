<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç GetCourse –±–ª–æ–∫–∞ –¥–ª—è UID 21179358</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .test-controls {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #1976d2;
        }
        .lesson-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .lesson-header {
            background: #424242;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç GetCourse –±–ª–æ–∫–∞</h1>
    
    <div class="info-box">
        <h3>‚ÑπÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞</h3>
        <p><strong>User ID:</strong> <code>21179358</code></p>
        <p><strong>API:</strong> <code>http://localhost:3000/api/persona/block</code></p>
        <p><strong>Lesson:</strong> <code data-lesson-num>2</code> (–Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞, –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)</p>
        <p><strong>–û–∂–∏–¥–∞–µ—Ç—Å—è:</strong> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ê–ª–µ–∫—Å–µ—è</p>
    </div>

    <div class="test-controls">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫:</h3>
        <button onclick="loadLesson(1)">–£—Ä–æ–∫ 1</button>
        <button onclick="loadLesson(2)">–£—Ä–æ–∫ 2</button>
        <button onclick="loadLesson(3)">–£—Ä–æ–∫ 3</button>
        <button onclick="loadLesson(5)">–£—Ä–æ–∫ 5</button>
        <button onclick="loadLesson(10)">–£—Ä–æ–∫ 10</button>
    </div>

    <div class="lesson-container">
        <div class="lesson-header">
            <h2 id="lesson-title">–£—Ä–æ–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</h2>
        </div>

        <!-- –¢–û–ß–ù–û –¢–ê–ö –ñ–ï –ö–ê–ö –í GETCOURSE -->
        <div id="persona-lesson-2" 
             data-lesson="2" 
             data-title="–®–í–ó –ú—ã—à—Ü—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —ç—Ç–æ–º –∫—É—Ä—Å–µ" 
             style="display:none;margin:30px 0;">
        </div>

        <script>
        (async function(){
          const API = "http://localhost:3000/api/persona"; // –õ–û–ö–ê–õ–¨–ù–´–ô API –î–õ–Ø –¢–ï–°–¢–ê
          const UID = "21179358"; // –¢–ï–°–¢–û–í–´–ô UID
          const userId = UID && UID !== "{uid}" ? String(UID) : "guest";
          const mount = document.getElementById('persona-lesson-2');
          const lesson = mount.getAttribute('data-lesson'); // –¢–µ–ø–µ—Ä—å "2"
          const title = mount.getAttribute('data-title');

          console.log('[Persona] Loading lesson:', { userId, lesson, title });

          try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑
            if (!document.querySelector('link[data-persona-styles]')) {
              const link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = 'http://localhost:3000/persona/styles.css'; // –õ–û–ö–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò
              link.setAttribute('data-persona-styles', '1');
              document.head.appendChild(link);
              console.log('[Persona] Styles loaded');
            }

            const requestBody = { 
              user_id: userId, 
              lesson: lesson,    // "2" –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
              title: title, 
              flush: false 
            };

            console.log('[Persona] Fetching:', API + '/block', requestBody);

            const r = await fetch(`${API}/block`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(requestBody)
            });
            
            console.log('[Persona] Response status:', r.status);
            
            const data = await r.json();
            
            console.log('[Persona] Response data:', data);
            
            if (data?.ok && data?.html) {
              mount.innerHTML = data.html;
              mount.style.display = 'block';
              console.log('[Persona] ‚úÖ Content loaded, HTML length:', data.html.length);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é
              const isPersonalized = data.html.includes('–ê–ª–µ–∫—Å–µ–π') || !data.html.includes('–ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è');
              console.log('[Persona] Is personalized:', isPersonalized);
            } else {
              console.warn('–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', data?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
              mount.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${data?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
              mount.style.display = 'block';
            }
          } catch(e) {
            console.error('Persona block error:', e);
            mount.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            mount.style.display = 'block';
          }
        })();
        </script>
    </div>

    <div class="info-box" style="background: #fff3e0; border-color: #ff9800;">
        <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞</h3>
        <p id="test-result">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤</p>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã —É—Ä–æ–∫–∞
        function loadLesson(lessonNum) {
            const mount = document.getElementById('persona-lesson-2');
            const titleElement = document.getElementById('lesson-title');
            document.querySelector('[data-lesson-num]').textContent = lessonNum;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã
            mount.setAttribute('data-lesson', lessonNum);
            mount.setAttribute('data-title', `–£—Ä–æ–∫ ${lessonNum}`);
            mount.innerHTML = '<p style="text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
            mount.style.display = 'block';
            
            titleElement.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞ ${lessonNum}...`;
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç
            const API = "http://localhost:3000/api/persona";
            const userId = "21179358";
            const lesson = String(lessonNum);
            const title = `–£—Ä–æ–∫ ${lessonNum}`;

            console.log(`\n======= LOADING LESSON ${lessonNum} =======`);
            console.log('[Persona] Request params:', { userId, lesson, title });

            fetch(`${API}/block`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ user_id: userId, lesson, title, flush: false })
            })
            .then(r => {
                console.log('[Persona] Response status:', r.status);
                return r.json();
            })
            .then(data => {
                console.log('[Persona] Response data:', data);
                
                if (data?.ok && data?.html) {
                    mount.innerHTML = data.html;
                    titleElement.textContent = `–£—Ä–æ–∫ ${lessonNum} –∑–∞–≥—Ä—É–∂–µ–Ω`;
                    
                    // –ê–Ω–∞–ª–∏–∑
                    const hasName = data.html.includes('–ê–ª–µ–∫—Å–µ–π');
                    const isDefault = data.html.includes('–ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è');
                    const isPersonalized = hasName && !isDefault;
                    
                    document.getElementById('test-result').innerHTML = `
                        <strong>–£—Ä–æ–∫ ${lessonNum}:</strong><br>
                        ‚Ä¢ –°–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è "–ê–ª–µ–∫—Å–µ–π": ${hasName ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}<br>
                        ‚Ä¢ –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${isDefault ? '‚ö†Ô∏è –î–∞' : '‚úÖ –ù–µ—Ç'}<br>
                        ‚Ä¢ <strong>–°—Ç–∞—Ç—É—Å: ${isPersonalized ? '‚úÖ –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù' : '‚ùå –ù–ï –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù'}</strong>
                    `;
                    
                    console.log('[Persona] ‚úÖ Success! Is personalized:', isPersonalized);
                } else {
                    mount.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${data?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
                    titleElement.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞ ${lessonNum}`;
                    console.error('[Persona] Error:', data);
                }
            })
            .catch(e => {
                console.error('[Persona] Fetch error:', e);
                mount.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${e.message}</div>`;
                titleElement.textContent = `–û—à–∏–±–∫–∞ —É—Ä–æ–∫–∞ ${lessonNum}`;
            });
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞ 2 –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Initial load complete, lesson 2 should be loaded');
            }, 1000);
        });
    </script>
</body>
</html>
