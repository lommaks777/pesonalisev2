<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç —É—Ä–æ–∫–∞ 2 - –ú–∞—Å—Å–∞–∂ –®–í–ó</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    h1 { color: #333; }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .info p {
      margin: 5px 0;
      font-size: 14px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ –¢–µ—Å—Ç –±–ª–æ–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ - –£—Ä–æ–∫ 2 (–ú–∞—Å—Å–∞–∂ –®–í–ó)</h1>
    
    <div class="info">
      <p><strong>–ö—É—Ä—Å:</strong> massazh-shvz</p>
      <p><strong>–£—Ä–æ–∫:</strong> 2</p>
      <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> 2. –¢–µ–æ—Ä–∏—è. –ú—ã—à—Ü—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —ç—Ç–æ–º –∫—É—Ä—Å</p>
      <p><strong>User ID:</strong> <span id="user-id-display">–∑–∞–≥—Ä—É–∑–∫–∞...</span></p>
      <p><strong>API:</strong> https://pesonalisev2-zxby.vercel.app/api/persona/block</p>
    </div>

    <div id="status-log"></div>
  </div>

  <!-- –¢–ï–°–¢–ò–†–£–ï–ú–´–ô –ë–õ–û–ö -->
  <div class="test-container">
    <h2>üì¶ –ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:</h2>
    <div id="persona-lesson-2" 
         data-lesson="2" 
         data-title="2. –¢–µ–æ—Ä–∏—è. –ú—ã—à—Ü—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —ç—Ç–æ–º –∫—É—Ä—Å"
         data-course="massazh-shvz" 
         style="display:none;margin:30px 0;">
      <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</div>
    </div>
  </div>

  <script>
    const statusLog = document.getElementById('status-log');
    const userIdDisplay = document.getElementById('user-id-display');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
      statusLog.appendChild(div);
      console.log(`[${type}]`, message);
    }

    (async function(){
      const API = "https://pesonalisev2-zxby.vercel.app/api/persona";
      const UID = "{uid}";
      const userId = UID && UID !== "{uid}" ? String(UID) : "guest";
      
      userIdDisplay.textContent = userId;
      log(`–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`, 'info');

      const mount = document.getElementById('persona-lesson-2');
      const lesson = mount.getAttribute('data-lesson');
      const title = mount.getAttribute('data-title');
      const course = mount.getAttribute('data-course');

      log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: lesson=${lesson}, course=${course}`, 'info');

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑
        if (!document.querySelector('link[data-persona-styles]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://pesonalisev2-zxby.vercel.app/persona/styles.css';
          link.setAttribute('data-persona-styles', '1');
          document.head.appendChild(link);
          log('–°—Ç–∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        }

        log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API...', 'info');
        
        const requestBody = { 
          user_id: userId, 
          lesson: lesson,
          title: title,
          course: course, 
          flush: false 
        };
        
        log(`–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: <pre>${JSON.stringify(requestBody, null, 2)}</pre>`, 'info');

        const r = await fetch(`${API}/block`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });
        
        log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${r.status} ${r.statusText}`, r.ok ? 'success' : 'error');
        
        const data = await r.json();
        
        log(`–û—Ç–≤–µ—Ç API: <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`, 'info');
        
        if (data?.ok && data?.html) {
          mount.innerHTML = data.html;
          mount.style.display = 'block';
          log('‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω', 'success');
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
          const htmlPreview = data.html.substring(0, 300);
          log(`–ü—Ä–µ–≤—å—é HTML: <pre>${htmlPreview}...</pre>`, 'info');
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–æ "—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ" –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
          if (data.html.toLowerCase().includes('—Ç–µ–π–ø')) {
            log('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í –∫–æ–Ω—Ç–µ–Ω—Ç–µ –Ω–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤–æ "—Ç–µ–π–ø"!', 'error');
          }
          
        } else {
          const errorMsg = data?.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          log(`‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${errorMsg}`, 'error');
          mount.innerHTML = `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç: ${errorMsg}</div>`;
          mount.style.display = 'block';
        }
      } catch(e) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
        log(`Stack: <pre>${e.stack}</pre>`, 'error');
        console.error('Persona block error:', e);
      }
    })();
  </script>
</body>
</html>
