# ‚úÖ Fix: Multi-Course Users Personalization

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **469887216 (–ü–æ–ª–∏–Ω–∞)** –∑–∞–ø–æ–ª–Ω–∏–ª –∞–Ω–∫–µ—Ç—É, –Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:

```
User: 469887216
Profiles found: 2

Profile 1:
  - Course: massazh-shvz (–®–í–ö–ó - –º–∞—Å—Å–∞–∂ —à–µ–∏)
  - Created: 2025-10-16 
  - Has survey: YES ‚úÖ

Profile 2:
  - Course: taping-basics (–¢–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ)  
  - Created: 2025-10-27 (—Å–µ–≥–æ–¥–Ω—è)
  - Has survey: YES ‚úÖ
```

**–ó–∞–ø—Ä–æ—Å:** —É—Ä–æ–∫ 2 –∏–∑ –∫—É—Ä—Å–∞ `taping-basics`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. API –∏—Å–∫–∞–ª –ø—Ä–æ—Ñ–∏–ª—å –ø–æ `user_identifier = "469887216"`
2. –ù–∞—Ö–æ–¥–∏–ª **–ü–ï–†–í–´–ô** –ø—Ä–æ—Ñ–∏–ª—å (–¥–ª—è –∫—É—Ä—Å–∞ `massazh-shvz`)
3. –ü—ã—Ç–∞–ª—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫ —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –∞–Ω–∫–µ—Ç—ã –¥–ª—è –º–∞—Å—Å–∞–∂–∞ –®–í–ö–ó
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞ ‚ùå

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `/app/api/persona/block/route.ts`

**–ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```typescript
// –®–∞–≥ 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
const { data: profile } = await supabase
  .from("profiles")
  .select("id, name, course_slug, survey")
  .eq("user_identifier", user_id)
  .maybeSingle();  // ‚ùå –ë–µ—Ä—ë—Ç –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è!

// –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É—Ä—Å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
if (course) {
  const { data: courseData } = await supabase
    .from("courses")
    .select("id")
    .eq("slug", course)
    .maybeSingle();
  // ...
}
```

**–°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```typescript
// –®–∞–≥ 1: –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É—Ä—Å
if (course) {
  const { data: courseData } = await supabase
    .from("courses")
    .select("id, slug")
    .eq("slug", course)
    .maybeSingle();
  courseId = courseData.id;
  courseSlug = courseData.slug;
}

// –®–∞–≥ 2: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –î–õ–Ø –≠–¢–û–ì–û –ö–£–†–°–ê
if (courseSlug) {
  const { data: profile } = await supabase
    .from("profiles")
    .select("id, name, course_slug, survey")
    .eq("user_identifier", user_id)
    .eq("course_slug", courseSlug)  // ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –∫—É—Ä—Å—É!
    .maybeSingle();
}
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
curl -X POST /api/persona/block \
  -d '{"user_id":"469887216","lesson":"2","course":"taping-basics"}'

# Response:
{
  "ok": true,
  "html": "üìò –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —É—Ä–æ–∫–∞ ... –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É"
}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
curl -X POST /api/persona/block \
  -d '{"user_id":"469887216","lesson":"2","course":"taping-basics"}'

# Response:
{
  "ok": true,
  "html": "... –Ω–∞ —Å–µ–±–µ –∏ –ø–æ–¥—Ä—É–≥–µ ... —É–º–µ–Ω—å—à–∏—Ç—å –æ—Ç–µ—á–Ω–æ—Å—Ç—å ..."
}
```

**–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ**

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–¥–ª—è taping-basics)
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∫–µ—Ç—ã —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –£–ø–æ–º–∏–Ω–∞–µ—Ç practice_model: "–ø–æ–¥—Ä—É–≥–∞"
- ‚úÖ –£–ø–æ–º–∏–Ω–∞–µ—Ç wow_result: "—É–º–µ–Ω—å—à–∏—Ç—å –æ—Ç–µ—á–Ω–æ—Å—Ç—å"
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç fears: "–Ω–∞–Ω–µ—Å–µ–Ω–∏—è –≤—Ä–µ–¥–∞"

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `course`
```typescript
Request: { user_id: "469887216", course: "taping-basics", lesson: "2" }

1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º courseId –ø–æ slug "taping-basics" ‚úÖ
2. –ò—â–µ–º profile WHERE user_id = "469887216" AND course_slug = "taping-basics" ‚úÖ
3. –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å survey –¥–ª—è —Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏—è ‚úÖ
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–ï –ø–µ—Ä–µ–¥–∞–Ω `course`, –Ω–æ –µ—Å—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ
```typescript
Request: { user_id: "123", lesson: "5" }

1. course –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—â–µ–º –ø—Ä–æ—Ñ–∏–ª—å –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫—É—Ä—Å—É
2. –ë–µ—Ä—ë–º profile.course_slug –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º courseId –ø–æ profile.course_slug
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º/–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π + –ù–ï –ø–µ—Ä–µ–¥–∞–Ω course
```typescript
Request: { user_id: "469887216", lesson: "2" }

‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2+ –ø—Ä–æ—Ñ–∏–ª—è –∏ course –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
- .maybeSingle() –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É "multiple rows returned"
- –ù—É–∂–Ω–æ –í–°–ï–ì–î–ê –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å course –≤ –∑–∞–ø—Ä–æ—Å–µ!
```

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è Frontend/GetCourse:
**–í–°–ï–ì–î–ê** –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `course` –≤ –∑–∞–ø—Ä–æ—Å–µ:

```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
fetch('/api/persona/block', {
  method: 'POST',
  body: JSON.stringify({
    user_id: uid,
    lesson: lessonNumber,
    course: "taping-basics"  // ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
  })
});

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—É—Ä—Å–æ–≤)
fetch('/api/persona/block', {
  method: 'POST',
  body: JSON.stringify({
    user_id: uid,
    lesson: lessonNumber
    // course –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚ùå
  })
});
```

### –î–ª—è Database:
–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—É—Ä—Å–æ–≤:

```sql
-- –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥–≤–∞ –∫—É—Ä—Å–∞
user_identifier: "469887216"
‚îú‚îÄ‚îÄ Profile 1: course_slug = "massazh-shvz"
‚îî‚îÄ‚îÄ Profile 2: course_slug = "taping-basics"

-- –ö–∞–∂–¥—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∏–º–µ–µ—Ç —Å–≤–æ–π survey –¥–ª—è —Å–≤–æ–µ–≥–æ –∫—É—Ä—Å–∞ ‚úÖ
```

---

## üêõ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Email –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:
```javascript
profile.name = "Meplnvrn@gmail.com"  // ‚ùå Email –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏!
survey.real_name = "–ü–æ–ª–∏–Ω–∞"          // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –∑–¥–µ—Å—å
```

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `profile.name` –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, –ø–æ—ç—Ç–æ–º—É –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è email.

### –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
–û–±–Ω–æ–≤–∏—Ç—å `profile.name` –∏–∑ `survey.real_name`:

```sql
UPDATE profiles 
SET name = survey->>'real_name'
WHERE user_identifier = '469887216' 
  AND course_slug = 'taping-basics';
```

–ò–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–æ–¥–µ API:
```typescript
const userName = profile.name?.includes('@') 
  ? (profile.survey?.real_name || 'Friend')
  : (profile.name || 'Friend');
```

---

## ‚úÖ Deployment

**Commit:** `b674768 - fix: filter profile by course_slug to handle users with multiple courses`

**Status:** 
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ó–∞–ø—É—à–µ–Ω–æ –≤ GitHub
- ‚è≥ Vercel –¥–µ–ø–ª–æ–∏—Ç (~2-3 –º–∏–Ω—É—Ç—ã)

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:** 
```
https://pesonalisev2-zxby.vercel.app/testlesson.html
```

---

## üéØ –ò—Ç–æ–≥

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ API —Ç–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ `course_slug`
2. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫—É—Ä—Å–∞–º–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é
3. ‚úÖ –ö–∞–∂–¥—ã–π –∫—É—Ä—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π survey
4. ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ:
- ‚ö†Ô∏è Email –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ –≤ –ø–æ–ª–µ `profile.name` (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- ‚úÖ –í–°–ï–ì–î–ê –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `course` –≤ API –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/api/persona/block`
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å GetCourse
